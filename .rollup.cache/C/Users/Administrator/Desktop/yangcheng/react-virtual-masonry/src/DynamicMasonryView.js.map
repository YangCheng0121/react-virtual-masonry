{"version":3,"file":"DynamicMasonryView.js","sourceRoot":"","sources":["DynamicMasonryView.tsx"],"names":[],"mappings":";AAAA,OAAO,KAAK,EAAE,EAAE,QAAQ,EAAE,SAAS,EAAE,WAAW,EAAE,MAAM,OAAO,CAAC;AAChE,OAAO,cAAc,MAAM,kBAAkB,CAAC;AAC9C,OAAO,2BAA2B,MAAM,+BAA+B,CAAC;AAExE,iDAAiD;AAEjD;;;;GAIG;AACH,MAAM,CAAN,IAAY,QAGX;AAHD,WAAY,QAAQ;IAClB,iDAAa,CAAA;IACb,uDAAgB,CAAA;AAClB,CAAC,EAHW,QAAQ,KAAR,QAAQ,QAGnB;AA6FD,gDAAgD;AAEhD;;;;;;GAMG;AACH,MAAM,CAAC,OAAO,UAAU,kBAAkB,CAAU,EAavB;IAC3B,iDAAiD;IAdnD,iBA6KC;QA5KY,mBAAmB,eAAA,EAC9B,wBAAuB,EAAvB,gBAAgB,mBAAG,IAAI,KAAA,EACvB,uBAAsB,EAAtB,eAAe,mBAAG,IAAI,KAAA,EACtB,uBAAoB,EAApB,eAAe,mBAAG,EAAE,KAAA,EACpB,yBAAsB,EAAtB,iBAAiB,mBAAG,EAAE,KAAA,EACtB,QAAQ,cAAA,EACR,gBAAa,EAAb,QAAQ,mBAAG,EAAE,KAAA,EACb,UAAU,gBAAA,EACV,OAAO,aAAA,EACP,mBAAmB,yBAAA,EACnB,kBAAkB,wBAAA,EAClB,OAAO,aAAA;IAID,IAAA,KAA4B,QAAQ,CACxC,mBAAmB,aAAnB,mBAAmB,cAAnB,mBAAmB,GAAI,IAAI,CAC5B,EAFM,SAAS,QAAA,EAAE,YAAY,QAE7B,CAAC;IACI,IAAA,KAA4C,QAAQ,CACxD,mBAAmB,KAAK,SAAS,CAClC,EAFM,iBAAiB,QAAA,EAAE,oBAAoB,QAE7C,CAAC;IACI,IAAA,KAAoC,QAAQ,CAGxC,IAAI,CAAC,EAHR,aAAa,QAAA,EAAE,gBAAgB,QAGvB,CAAC;IAEhB,IAAM,WAAW,GAAG,KAAK,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;IAC3C,IAAM,qBAAqB,GAAG,KAAK,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC;IAC/D,IAAM,UAAU,GAAG,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;IAEzC,KAAK,CAAC,SAAS,CAAC;QACd,WAAW,CAAC,OAAO,GAAG,QAAQ,CAAC;QAC/B,qBAAqB,CAAC,OAAO,GAAG,kBAAkB,CAAC;QACnD,UAAU,CAAC,OAAO,GAAG,OAAO,CAAC;IAC/B,CAAC,EAAE,CAAC,QAAQ,EAAE,kBAAkB,EAAE,OAAO,CAAC,CAAC,CAAC;IAE5C,sDAAsD;IAEtD,IAAM,eAAe,GAAG,WAAW,CACjC,UAAO,IAAY,EAAE,IAAY;;;;;oBAC/B,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;wBACzB,sBAAO,EAAE,IAAI,EAAE,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,EAAC;oBACtC,CAAC;oBAED,IAAI,IAAI,KAAK,CAAC,IAAI,aAAa,EAAE,CAAC;wBAC1B,MAAM,GAAG,aAAa,CAAC;wBAC7B,gBAAgB,CAAC,IAAI,CAAC,CAAC;wBACvB,sBAAO,MAAM,EAAC;oBAChB,CAAC;oBAEc,qBAAM,WAAW,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,EAAA;;oBAA9C,MAAM,GAAG,SAAqC;oBAEpD,sBAAO;4BACL,IAAI,EAAE,MAAM,CAAC,IAAI;4BACjB,OAAO,EAAE,MAAM,CAAC,OAAO;yBACxB,EAAC;;;SACH,EACD,CAAC,aAAa,CAAC,CAChB,CAAC;IAEF,oDAAoD;IAEpD,SAAS,CAAC;;QACR,IAAI,mBAAmB,KAAK,SAAS,EAAE,CAAC;YACtC,YAAY,CAAC,mBAAmB,CAAC,CAAC;YAClC,oBAAoB,CAAC,KAAK,CAAC,CAAC;YAC5B,MAAA,qBAAqB,CAAC,OAAO,sEAAG,mBAAmB,CAAC,CAAC;QACvD,CAAC;IACH,CAAC,EAAE,CAAC,mBAAmB,CAAC,CAAC,CAAC;IAE1B,IAAM,cAAc,GAAG,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IAE3C,SAAS,CAAC;QACR,IAAI,mBAAmB,KAAK,SAAS,EAAE,CAAC;YACtC,OAAO;QACT,CAAC;QAED,IAAI,cAAc,CAAC,OAAO,EAAE,CAAC;YAC3B,OAAO;QACT,CAAC;QAED,IAAM,oBAAoB,GAAG;;;;;;;wBAEzB,oBAAoB,CAAC,IAAI,CAAC,CAAC;wBAC3B,cAAc,CAAC,OAAO,GAAG,IAAI,CAAC;6BAE1B,WAAW,CAAC,OAAO,EAAnB,wBAAmB;wBACN,qBAAM,WAAW,CAAC,OAAO,CAAC,CAAC,EAAE,QAAQ,CAAC,EAAA;;wBAA/C,MAAM,GAAG,SAAsC;wBAErD,gBAAgB,CAAC;4BACf,IAAI,EAAE,MAAM,CAAC,IAAI;4BACjB,OAAO,EAAE,MAAM,CAAC,OAAO;yBACxB,CAAC,CAAC;wBAEH,IAAI,MAAM,CAAC,SAAS,KAAK,SAAS,EAAE,CAAC;4BACnC,YAAY,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;4BAC/B,MAAA,qBAAqB,CAAC,OAAO,sEAAG,MAAM,CAAC,SAAS,CAAC,CAAC;wBACpD,CAAC;6BAAM,CAAC;4BACN,YAAY,CAAC,gBAAgB,CAAC,CAAC;4BAC/B,MAAA,qBAAqB,CAAC,OAAO,sEAAG,gBAAgB,CAAC,CAAC;wBACpD,CAAC;;;wBAED,YAAY,CAAC,gBAAgB,CAAC,CAAC;wBAC/B,MAAA,qBAAqB,CAAC,OAAO,sEAAG,gBAAgB,CAAC,CAAC;;;;;wBAGpD,OAAO,CAAC,KAAK,CAAC,6BAA6B,EAAE,OAAK,CAAC,CAAC;wBACpD,MAAA,UAAU,CAAC,OAAO,2DAAG,OAAc,CAAC,CAAC;wBACrC,YAAY,CAAC,gBAAgB,CAAC,CAAC;;;wBAE/B,oBAAoB,CAAC,KAAK,CAAC,CAAC;;;;;aAE/B,CAAC;QAEF,oBAAoB,EAAE,CAAC;QACvB,4CAA4C;QAC5C,sDAAsD;QACtD,iCAAiC;QACjC,uDAAuD;IACzD,CAAC,EAAE,CAAC,mBAAmB,EAAE,QAAQ,CAAC,CAAC,CAAC;IAEpC,iDAAiD;IAEjD,IAAI,iBAAiB,IAAI,SAAS,KAAK,IAAI,EAAE,CAAC;QAC5C,uBAAuB;QACvB,IAAI,mBAAmB,EAAE,CAAC;YACxB,OAAO,0CAAG,mBAAmB,EAAE,CAAI,CAAC;QACtC,CAAC;QACD,QAAQ;QACR,OAAO,CACL,6BACE,KAAK,EAAE;gBACL,KAAK,EAAE,MAAM;gBACb,OAAO,EAAE,MAAM;gBACf,UAAU,EAAE,QAAQ;gBACpB,cAAc,EAAE,QAAQ;aACzB,GACD,CACH,CAAC;IACJ,CAAC;IAED,IAAI,SAAS,EAAE,CAAC;QACd,OAAO,CACL,oBAAC,cAAc,IACb,UAAU,EAAE,UAAC,IAAI,EAAE,KAAK,IAAK,OAAA,UAAU,CAAC,IAAI,EAAE,KAAK,EAAE,IAAI,CAAC,EAA7B,CAA6B,EAC1D,eAAe,EAAE,eAAe,EAChC,QAAQ,EAAE,eAAe,EACzB,QAAQ,EAAE,QAAQ,EAClB,cAAc,EAAE,eAAe,CAAC,cAAc,EAC9C,cAAc,EAAE,eAAe,CAAC,cAAc,EAC9C,GAAG,EAAE,eAAe,CAAC,GAAG,EACxB,MAAM,EAAE,eAAe,CAAC,MAAM,EAC9B,OAAO,EAAE,OAAO,GAChB,CACH,CAAC;IACJ,CAAC;IAED,OAAO,CACL,oBAAC,2BAA2B,IAC1B,UAAU,EAAE,UAAC,IAAI,EAAE,KAAK,IAAK,OAAA,UAAU,CAAC,IAAI,EAAE,KAAK,EAAE,KAAK,CAAC,EAA9B,CAA8B,EAC3D,eAAe,EAAE,eAAe,EAChC,QAAQ,EAAE,eAAe,EACzB,QAAQ,EAAE,QAAQ,EAClB,eAAe,EAAE,iBAAiB,CAAC,eAAe,EAClD,SAAS,EAAE,iBAAiB,CAAC,SAAS,EACtC,YAAY,EAAE,iBAAiB,CAAC,YAAY,EAC5C,eAAe,EAAE,iBAAiB,CAAC,eAAe,EAClD,GAAG,EAAE,iBAAiB,CAAC,GAAG,EAC1B,MAAM,EAAE,iBAAiB,CAAC,MAAM,EAChC,OAAO,EAAE,OAAO,GAChB,CACH,CAAC;AACJ,CAAC","sourcesContent":["import React, { useState, useEffect, useCallback } from \"react\";\nimport VirtualMasonry from \"./VirtualMasonry\";\nimport FullWidthEqualHeightMasonry from \"./FullWidthEqualHeightMasonry\";\n\n// ==================== 类型定义 ====================\n\n/**\n * 视图类型枚举\n * 1 - 瀑布流(不等宽不等高)\n * 2 - 等高不等宽\n */\nexport enum ViewType {\n  WATERFALL = 1,\n  EQUAL_HEIGHT = 2,\n}\n\n/**\n * 数据加载函数\n * 第一次调用时(page === 1)会返回布局类型\n * 后续调用不返回布局类型\n */\nexport type LoadDataFn<T = any> = (\n  page: number,\n  pageSize: number,\n) => Promise<{\n  data: T[];\n  hasMore: boolean;\n  isMasonry?: boolean;\n}>;\n\n/**\n * 组件 Props\n */\nexport interface DynamicMasonryViewProps<T = any> {\n  /**\n   * 是否使用瀑布流布局(受控模式)\n   */\n  isMasonry?: boolean;\n\n  /**\n   * 默认是否使用瀑布流布局(非受控模式)\n   */\n  defaultIsMasonry?: boolean;\n\n  /**\n   * 是否启用动画\n   */\n  enableAnimation?: boolean;\n\n  /**\n   * 映射宽高\n   */\n  mapSize?: (raw: any) => { width: number; height: number };\n\n  /**\n   * 瀑布流配置\n   */\n  waterfallConfig?: {\n    minColumnWidth?: number;\n    maxColumnWidth?: number;\n    gap?: number;\n    buffer?: number;\n  };\n\n  /**\n   * 等高不等宽配置\n   */\n  equalHeightConfig?: {\n    targetRowHeight?: number;\n    sizeRange?: [number, number];\n    maxItemWidth?: number;\n    maxStretchRatio?: number;\n    gap?: number;\n    buffer?: number;\n  };\n\n  /**\n   * 自定义初始加载状态\n   */\n  renderInitialLoader?: () => React.ReactNode;\n\n  /**\n   * 自定义数据加载函数\n   */\n  loadData?: LoadDataFn<T>;\n\n  /**\n   * 每页数据条数\n   */\n  pageSize?: number;\n\n  /**\n   * 自定义渲染项\n   */\n  renderItem: (item: any, index: number, isMasonry: boolean) => React.ReactNode;\n\n  /**\n   * 布局类型加载完成回调\n   */\n  onLayoutTypeLoaded?: (isMasonry: boolean) => void;\n\n  /**\n   * 数据加载错误回调\n   */\n  onError?: (error: Error) => void;\n}\n\n// ==================== 主组件 ====================\n\n/**\n * 动态瀑布流视图组件\n *\n * 支持两种视图模式:\n * 1. 瀑布流(不等宽不等高) - Pinterest 风格\n * 2. 等高不等宽 - Google Photos 风格\n */\nexport default function DynamicMasonryView<T = any>({\n  isMasonry: controlledIsMasonry,\n  defaultIsMasonry = true,\n  enableAnimation = true,\n  waterfallConfig = {},\n  equalHeightConfig = {},\n  loadData,\n  pageSize = 50,\n  renderItem,\n  mapSize,\n  renderInitialLoader,\n  onLayoutTypeLoaded,\n  onError,\n}: DynamicMasonryViewProps<T>) {\n  // ==================== 状态管理 ====================\n\n  const [isMasonry, setIsMasonry] = useState<boolean | null>(\n    controlledIsMasonry ?? null,\n  );\n  const [layoutTypeLoading, setLayoutTypeLoading] = useState(\n    controlledIsMasonry === undefined,\n  );\n  const [firstPageData, setFirstPageData] = useState<{\n    data: T[];\n    hasMore: boolean;\n  } | null>(null);\n\n  const loadDataRef = React.useRef(loadData);\n  const onLayoutTypeLoadedRef = React.useRef(onLayoutTypeLoaded);\n  const onErrorRef = React.useRef(onError);\n\n  React.useEffect(() => {\n    loadDataRef.current = loadData;\n    onLayoutTypeLoadedRef.current = onLayoutTypeLoaded;\n    onErrorRef.current = onError;\n  }, [loadData, onLayoutTypeLoaded, onError]);\n\n  // ==================== 包装的数据加载函数 ====================\n\n  const wrappedLoadData = useCallback(\n    async (page: number, size: number) => {\n      if (!loadDataRef.current) {\n        return { data: [], hasMore: false };\n      }\n\n      if (page === 1 && firstPageData) {\n        const cached = firstPageData;\n        setFirstPageData(null);\n        return cached;\n      }\n\n      const result = await loadDataRef.current(page, size);\n\n      return {\n        data: result.data,\n        hasMore: result.hasMore,\n      };\n    },\n    [firstPageData],\n  );\n\n  // ==================== 初始化布局类型 ====================\n\n  useEffect(() => {\n    if (controlledIsMasonry !== undefined) {\n      setIsMasonry(controlledIsMasonry);\n      setLayoutTypeLoading(false);\n      onLayoutTypeLoadedRef.current?.(controlledIsMasonry);\n    }\n  }, [controlledIsMasonry]);\n\n  const initializedRef = React.useRef(false);\n\n  useEffect(() => {\n    if (controlledIsMasonry !== undefined) {\n      return;\n    }\n\n    if (initializedRef.current) {\n      return;\n    }\n\n    const initializeLayoutType = async () => {\n      try {\n        setLayoutTypeLoading(true);\n        initializedRef.current = true;\n\n        if (loadDataRef.current) {\n          const result = await loadDataRef.current(1, pageSize);\n\n          setFirstPageData({\n            data: result.data,\n            hasMore: result.hasMore,\n          });\n\n          if (result.isMasonry !== undefined) {\n            setIsMasonry(result.isMasonry);\n            onLayoutTypeLoadedRef.current?.(result.isMasonry);\n          } else {\n            setIsMasonry(defaultIsMasonry);\n            onLayoutTypeLoadedRef.current?.(defaultIsMasonry);\n          }\n        } else {\n          setIsMasonry(defaultIsMasonry);\n          onLayoutTypeLoadedRef.current?.(defaultIsMasonry);\n        }\n      } catch (error) {\n        console.error(\"Failed to load layout type:\", error);\n        onErrorRef.current?.(error as Error);\n        setIsMasonry(defaultIsMasonry);\n      } finally {\n        setLayoutTypeLoading(false);\n      }\n    };\n\n    initializeLayoutType();\n    // 只在 controlledIsMasonry, pageSize 变化时重新初始化\n    // 移除 defaultIsMasonry 依赖，避免接口返回后更新 layoutType 导致重复初始化\n    // loadData 等函数通过 ref 访问，不需要作为依赖项\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [controlledIsMasonry, pageSize]);\n\n  // ==================== 渲染逻辑 ====================\n\n  if (layoutTypeLoading || isMasonry === null) {\n    // 使用自定义初始加载状态，或使用默认占位符\n    if (renderInitialLoader) {\n      return <>{renderInitialLoader()}</>;\n    }\n    // 默认占位符\n    return (\n      <div\n        style={{\n          width: \"100%\",\n          display: \"flex\",\n          alignItems: \"center\",\n          justifyContent: \"center\",\n        }}\n      />\n    );\n  }\n\n  if (isMasonry) {\n    return (\n      <VirtualMasonry\n        renderItem={(item, index) => renderItem(item, index, true)}\n        enableAnimation={enableAnimation}\n        loadData={wrappedLoadData}\n        pageSize={pageSize}\n        minColumnWidth={waterfallConfig.minColumnWidth}\n        maxColumnWidth={waterfallConfig.maxColumnWidth}\n        gap={waterfallConfig.gap}\n        buffer={waterfallConfig.buffer}\n        mapSize={mapSize}\n      />\n    );\n  }\n\n  return (\n    <FullWidthEqualHeightMasonry\n      renderItem={(item, index) => renderItem(item, index, false)}\n      enableAnimation={enableAnimation}\n      loadData={wrappedLoadData}\n      pageSize={pageSize}\n      targetRowHeight={equalHeightConfig.targetRowHeight}\n      sizeRange={equalHeightConfig.sizeRange}\n      maxItemWidth={equalHeightConfig.maxItemWidth}\n      maxStretchRatio={equalHeightConfig.maxStretchRatio}\n      gap={equalHeightConfig.gap}\n      buffer={equalHeightConfig.buffer}\n      mapSize={mapSize}\n    />\n  );\n}"]}