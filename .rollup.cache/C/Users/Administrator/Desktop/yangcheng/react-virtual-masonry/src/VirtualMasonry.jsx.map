{"version":3,"file":"VirtualMasonry.jsx","sourceRoot":"","sources":["VirtualMasonry.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, {\n  useState,\n  useEffect,\n  useRef,\n  useMemo,\n  useLayoutEffect,\n  useCallback,\n} from \"react\";\n\ntype VirtualMasonryCoreProps = {\n  items: any[];\n  renderItem: (item: any, index: number) => React.ReactNode;\n  onLoadMore?: () => void;\n  minColumnWidth?: number;\n  maxColumnWidth?: number;\n  gap?: number;\n  buffer?: number;\n  hasMore?: boolean;\n  loading?: boolean;\n  loadMoreThreshold?: number;\n};\n\n// RAF 节流 Hook - 使用 requestAnimationFrame 优化滚动性能\nfunction useRafThrottle<T>(value: T): T {\n  const [throttledValue, setThrottledValue] = useState(value);\n  const rafRef = useRef<number | null>(null);\n  const valueRef = useRef(value);\n\n  useEffect(() => {\n    valueRef.current = value;\n\n    if (rafRef.current !== null) {\n      return;\n    }\n\n    rafRef.current = requestAnimationFrame(() => {\n      setThrottledValue(valueRef.current);\n      rafRef.current = null;\n    });\n\n    return () => {\n      if (rafRef.current !== null) {\n        cancelAnimationFrame(rafRef.current);\n        rafRef.current = null;\n      }\n    };\n  }, [value]);\n\n  return throttledValue;\n}\n\n// ==================== 布局算法 Hook ====================\nfunction useMasonryLayout(\n  items: any[],\n  containerWidth: number,\n  minColumnWidth = 200,\n  maxColumnWidth?: number,\n  gap = 16,\n) {\n  const columnCount = useMemo(() => {\n    let cols = Math.max(1, Math.floor(containerWidth / minColumnWidth));\n\n    if (maxColumnWidth) {\n      const calculatedWidth = (containerWidth - gap * (cols - 1)) / cols;\n      while (calculatedWidth > maxColumnWidth && cols < 20) {\n        cols++;\n        const newWidth = (containerWidth - gap * (cols - 1)) / cols;\n        if (newWidth <= maxColumnWidth) break;\n      }\n    }\n\n    return cols;\n  }, [containerWidth, minColumnWidth, maxColumnWidth, gap]);\n\n  const layout = useMemo(() => {\n    if (!containerWidth) return [];\n    const columnHeights = Array(columnCount).fill(0);\n    let columnWidth = (containerWidth - gap * (columnCount - 1)) / columnCount;\n\n    if (maxColumnWidth && columnWidth > maxColumnWidth) {\n      columnWidth = maxColumnWidth;\n    }\n\n    return items.map((item) => {\n      const minCol = columnHeights.indexOf(Math.min(...columnHeights));\n      const x = (columnWidth + gap) * minCol;\n      const y = columnHeights[minCol];\n\n      const aspectRatio = item.height / item.width;\n      const scaledHeight = columnWidth * aspectRatio;\n\n      columnHeights[minCol] += scaledHeight + gap;\n\n      return {\n        ...item,\n        x,\n        y,\n        width: columnWidth,\n        height: scaledHeight,\n      };\n    });\n  }, [items, columnCount, containerWidth, maxColumnWidth, gap]);\n\n  const totalHeight = useMemo(() => {\n    if (layout.length === 0) return 0;\n    const columnHeights = Array(columnCount).fill(0);\n    layout.forEach((item) => {\n      const colIndex = Math.round(\n        item.x /\n          ((containerWidth - gap * (columnCount - 1)) / columnCount + gap),\n      );\n      columnHeights[colIndex] = Math.max(\n        columnHeights[colIndex],\n        item.y + item.height,\n      );\n    });\n    return Math.max(...columnHeights);\n  }, [layout, columnCount, containerWidth, gap]);\n\n  return { layout, totalHeight, columnCount };\n}\n\n// ==================== 主组件 ====================\nexport function VirtualMasonryCore({\n  items,\n  renderItem,\n  onLoadMore,\n  minColumnWidth = 200,\n  maxColumnWidth,\n  gap = 16,\n  buffer = 300,\n  hasMore = true,\n  loading = false,\n  loadMoreThreshold = 500,\n}: VirtualMasonryCoreProps) {\n  const [containerWidth, setContainerWidth] = useState(0);\n  const [scrollTop, setScrollTop] = useState(0);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const loadMoreTriggerRef = useRef<HTMLDivElement>(null);\n\n  const throttledScrollTop = useRafThrottle(scrollTop);\n\n  useLayoutEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const resizeObserver = new ResizeObserver(() => {\n      setContainerWidth(container.clientWidth);\n    });\n    resizeObserver.observe(container);\n    setContainerWidth(container.clientWidth);\n\n    return () => resizeObserver.disconnect();\n  }, []);\n\n  const { layout, totalHeight } = useMasonryLayout(\n    items,\n    containerWidth,\n    minColumnWidth,\n    maxColumnWidth,\n    gap,\n  );\n\n  const handleScroll = useCallback(() => {\n    if (!containerRef.current) return;\n    // 使用 getBoundingClientRect 获取准确的容器位置\n    const rect = containerRef.current.getBoundingClientRect();\n    // rect.top 为负数表示容器顶部已滚出视口，取其绝对值即为已滚动距离\n    const scrollTop = Math.max(0, -rect.top);\n    setScrollTop(scrollTop);\n  }, []);\n\n  useEffect(() => {\n    window.addEventListener(\"scroll\", handleScroll, { passive: true });\n    return () => window.removeEventListener(\"scroll\", handleScroll);\n  }, [handleScroll]);\n\n  useEffect(() => {\n    if (!onLoadMore || !hasMore || loading) return;\n\n    const trigger = loadMoreTriggerRef.current;\n    if (!trigger) return;\n\n    const observer = new IntersectionObserver(\n      (entries) => {\n        if (entries[0].isIntersecting) {\n          onLoadMore();\n        }\n      },\n      { rootMargin: `${loadMoreThreshold}px` },\n    );\n\n    observer.observe(trigger);\n    return () => observer.disconnect();\n  }, [onLoadMore, hasMore, loading, loadMoreThreshold]);\n\n  const visibleItems = useMemo(() => {\n    return layout.filter((item) => {\n      const viewTop = throttledScrollTop - buffer;\n      const viewBottom = throttledScrollTop + window.innerHeight + buffer;\n      return item.y + item.height >= viewTop && item.y <= viewBottom;\n    });\n  }, [layout, throttledScrollTop, buffer]);\n\n  return (\n    <div\n      ref={containerRef}\n      style={{\n        position: \"relative\",\n        width: \"100%\",\n        minHeight: totalHeight,\n      }}\n    >\n      {visibleItems.map((item, index) => renderItem(item, index))}\n\n      {onLoadMore && (\n        <div\n          ref={loadMoreTriggerRef}\n          style={{\n            position: \"absolute\",\n            bottom: 0,\n            left: 0,\n            right: 0,\n            height: 1,\n            pointerEvents: \"none\",\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nexport type VirtualMasonryProps = {\n  mapSize?: (raw: any) => { width: number; height: number };\n  renderItem: (item: any, index: number) => React.ReactNode;\n  enableAnimation?: boolean;\n  loadData?: (\n    page: number,\n    pageSize: number,\n  ) => Promise<{\n    data: any[];\n    hasMore: boolean;\n  }>;\n  pageSize?: number;\n  minColumnWidth?: number;\n  maxColumnWidth?: number;\n  gap?: number;\n  buffer?: number;\n  loadMoreThreshold?: number;\n};\n\nexport default function VirtualMasonry({\n  mapSize,\n  renderItem,\n  loadData,\n  pageSize = 50,\n  minColumnWidth = 200,\n  maxColumnWidth,\n  gap = 16,\n  buffer = 1500,\n  loadMoreThreshold = 800,\n}: VirtualMasonryProps) {\n  const [items, setItems] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true); // 初始设为 true，立即显示 Loader\n  const [hasMore, setHasMore] = useState(true);\n  const [page, setPage] = useState(1);\n\n  // 防止重复初始加载\n  const initialLoadRef = useRef(false);\n\n  const defaultMapSize = (d: any) => ({\n    width: d.width ?? d.w ?? d.imgW,\n    height: d.height ?? d.h ?? d.imgH,\n  });\n\n  // 使用 ref 存储最新的函数引用，避免依赖变化\n  const loadDataRef = useRef(loadData);\n  const mapSizeRef = useRef(mapSize);\n\n  useEffect(() => {\n    loadDataRef.current = loadData;\n    mapSizeRef.current = mapSize;\n  }, [loadData, mapSize]);\n\n  const handleLoadMore = useCallback(\n    (force = false) => {\n      // force 参数用于初始加载时跳过 loading 检查\n      if (!force && loading) return;\n\n      setLoading(true);\n\n      if (loadDataRef.current) {\n        loadDataRef\n          .current(page, pageSize)\n          .then(({ data, hasMore: more }) => {\n            const effectiveMapSize = mapSizeRef.current ?? defaultMapSize;\n\n            setItems((prev) => [\n              ...prev,\n              ...data.map((d) => {\n                const { width, height } = effectiveMapSize(d);\n                return {\n                  ...d,\n                  width,\n                  height,\n                  widthRatio: width / height,\n                };\n              }),\n            ]);\n            setHasMore(more);\n            setPage((prev) => prev + 1);\n          })\n          .catch((error) => {\n            console.error(\"Failed to load data:\", error);\n          })\n          .finally(() => {\n            setLoading(false);\n          });\n      }\n    },\n    [loading, page, pageSize],\n  );\n\n  // 初始加载 - 使用 ref 防止重复调用\n  useEffect(() => {\n    if (!initialLoadRef.current && items.length === 0) {\n      initialLoadRef.current = true;\n      handleLoadMore(true); // 传入 force = true，跳过 loading 检查\n    }\n  }, [handleLoadMore, items.length]);\n\n  return (\n    <VirtualMasonryCore\n      items={items}\n      renderItem={renderItem}\n      onLoadMore={handleLoadMore}\n      minColumnWidth={minColumnWidth}\n      maxColumnWidth={maxColumnWidth}\n      gap={gap}\n      buffer={buffer}\n      hasMore={hasMore}\n      loading={loading}\n      loadMoreThreshold={loadMoreThreshold}\n    />\n  );\n}"]}